# highload
Проектирование веб-сервиса

## 1. Тема проекта:
Стриминговый аудио сервис - https://music.yandex.ru/

## 2. Целевая аудитория сервиса:
Статистику взяла с <https://radar.yandex.ru/yandex?month=2021-01>

Месячная аудитория в среднем порядка 12 млн п/мес.

Дневная аудитория в среднем 2 млн п/мес.

Время среднее 3ч 23мин = 203 мин аудиоконтента в день.


## 3. MVP проекта:
 1 - Авторизация, регистрация. 2 - Музыка пользователя, плейлисты (популярные, дневной).  
 
 Будем рассматривать основной функционал - прослушивание музыки.
 

## 4. Выбор планируемой нагрузки:
Нагрузку на добавление песен можно не учитывать, так как она достаточно мала и незначительна по сравнению с нагрузкой, которая приходится на отдачу музыки.

Имеем, что в среднем пользователь сервиса в день слушает 203 минуты аудиоконтента. Среднее количество пользователей в день 2 миллона.
Будем считать, что сервис передает треки в максимальном качестве с битрейтом 320 kbps. Передачу среднего качества музыки возьмем равным 192 kbps.
Данные взяла из статьи <https://roem.ru/02-02-2016/218250/music-yandex-hifi/>

### Рассчет веса одной песни:
Таким образом, **минимальный вес с максимальным качеством за 1 минуту**: 320(kbps) * 60(сек) = 19200 КБит = 2400 КБайт = 2,34375 МБайта ~ 2,344 МБайта.

Возьмем среднюю величину, а именно с битрейтом 192 kbps, и будем считать, что это минимально возможный вес песни. Помимо этого, сервис сам может регулировать нагрузку и снижать битрейт при необходимости.

Получаем **минимальный вес 1 минуты**: 192(kbps) * 60(сек) = 11400 КБит = 1425 КБайт ~ 1,391 МБайта.

Так как большая часть музыки все же передается со средним качеством музыки, части песен нет в максимальном качестве, и не все пользователи слушают платную Яндекс.Музыку, то будем считать, чо у нас в сервисе в среднем 50% музыки с битрейтом 192 kbps и 50% музыки с битрейтом 320 kbps. Так же предположим, что пользователь будет слушать и ту, и другую музыку равновероятно.

Постчитаем **средний вес одной минуты песни**: (2,344 МБ + 1,391 МБ)/2 ~ 1,9 МБайт.
Одна песня весит примерно 7 МБайт.
Рассчитаем дневную нагрузку. Дневная аудитория ~2 млн пользователей. В среднем люди тратят на прослушивание музыки около 203 минут в день. Тогда дневной трафик составляет:
2 * 10^6 * 203 * 1,9 = 735 TБайт

### Рассчет объема хранилища:
Медиатека Яндекс.Музыки составляет [более 60 млн треков](https://vc.ru/media/96460-chislo-podpischikov-yandeks-muzyki-vyroslo-v-tri-raza-za-poltora-goda-i-dostiglo-3-mln "более 60 млн треков"). Будем считать, что каждая песня хранится в двух битрейтах для удобства отдачи в бесплатной и платной версиях. Таким образом, 1 минута песни с минимальным качеством весит 1,4 Мбайта, а в наилучшем качестве - 2,4 Мбайта. Получаем, что одна минута песни весит (1,4 + 2,344) = 3,744 Мбайта, тогда целая песня примерно 15 Мбайта.
Тогда минимальный объем хранилища для музыки составляет 60 * 10^6 * 15 = 859 Тбайт.

### Рассчет трафика:
**Один пользователь скачивает за день** в среднем: 203(мин) * 1,867(МБ) = 379,001 МБайт аудиоконтента.

За **один день в среднем с нашего сайта скачивается** 379,001(МБ) * 2 000 000(пользоветелй) = 758 002 000 МБайт  музыки ~ 722,887 ТБайт ~ 68,5 ГБит/с

Учтем, что при дневном пике нагрузка возрастает в 2.5 раза.

Таким образом, **в дневной пик количество пользователей** увеличивается до 2,5 x (2(млн польз.)/24)(среднее кол-во пользователей в час) ~ 208 333 пользоветеле в час.
**Нагрузка на дневной пик** составляет 379,001(МБ) * 208333(польз./час) ~ 78 958 415 МБайт в час = 75,3 ТБайт в час ~ 171,3 Гбит/с

### Рассчет количества RPS:
Выполним примерную оценку количества RPS для сервиса. За 203 минуты пользователь прослушивает примерно 51 песню (примерно 4 минуты на 1 песню), пусть за каждой песней он совершает один запрос в бд. Так же в процессе прослушивания у пользователя может возникнуть необходимость переключить трек, найти другую песню, открыть альбом группы и др. Будем считать, что на каждую песню совершается еще по два дополнительных запроса. 
**Предполагаемая нагрузка**: 2 * 10^6 * 51 * 3 / 24 / 60 / 60 = 3542 rps

## Логическая схема базы данных
![Untitled Diagram (1)](https://user-images.githubusercontent.com/49959597/113514955-36086280-957a-11eb-9274-62c43ad89aaa.png)

